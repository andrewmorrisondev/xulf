name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  actions: read
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Nx affected command accuracy

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"  # Specify Node.js version
          cache: 'npm'        # Caches npm packages automatically
      # install dependencies
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      # Cache Nx and node_modules for faster CI builds
      - name: Cache Nx and Node Modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/nx
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/nx.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Start Nx Cloud CI run with task distribution
      - name: Start Nx Cloud Distributed Task Execution
        run: npx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="e2e"

      # Install dependencies
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

  lint:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Run affected lint
        run: npx nx affected --target=lint --parallel=3

  test:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Run affected tests
        run: npx nx affected --target=test --parallel=3

      - name: TypeScript Type Checking
        run: npx nx affected --target=type-check --parallel=3

      - name: Security Vulnerability Scanning
        run: npm audit --audit-level=high

      - name: Accessibility Checks
        run: npx pa11y-ci

  build:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Run affected build
        run: npx nx affected --target=build --parallel=3
